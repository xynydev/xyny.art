---
import GenartLayout from "@layouts/GenartLayout.astro";
---

<GenartLayout title="new">
    <script>
        import { runP5Sketch } from "src/util/p5";

        runP5Sketch(async (p) => {
            let fonts = [
                {
                    font: await p.loadFont(
                        "https://fonts.googleapis.com/css2?family=Syne:wght@400..800&display=swap",
                    ),
                    range: [400, 800],
                },
                {
                    font: await p.loadFont(
                        "https://fonts.googleapis.com/css2?family=Recursive:wght@300..1000&display=swap",
                    ),
                    range: [300, 1000],
                },
                {
                    font: await p.loadFont(
                        "https://fonts.googleapis.com/css2?family=DynaPuff:wght@400..700&display=swap",
                    ),
                    range: [400, 700],
                },
                {
                    font: await p.loadFont(
                        "https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400..800&display=swap",
                    ),
                    range: [400, 800],
                },
            ];

            let fontSize = 32;

            let messages = [];
            let idx = 0;
            console.log(messages);

            const socket = new WebSocket(
                "wss://jetstream2.us-east.bsky.network/subscribe?wantedCollections=app.bsky.feed.post",
            );
            socket.addEventListener("message", (event) => {
                if (p.random() < 0.7) return;

                let eventData = JSON.parse(event.data);
                let message = eventData?.commit?.record?.text;
                if (message.includes("\n")) {
                    message = message.split("\n")[0];
                }
                if (message === undefined || message === "") return;
                messages[idx] = message;
                idx = (idx + 1) % Math.floor(p.height / fontSize + 3);
            });

            return (p) => {
                p.background(255);
                for (let i = 0; i < messages.length; i++) {
                    let message = messages[i];

                    p.textStyle(p.ITALIC);
                    p.textSize(
                        fontSize *
                            p.map(
                                p.cos(i + p.millis() / 1000),
                                -1,
                                1,
                                0.3,
                                1.3,
                            ),
                    );
                    let font = fonts[i % fonts.length];

                    let weight = p.map(
                        p.sin(p.millis() / 1000 + i),
                        -1,
                        1,
                        font.range[0],
                        font.range[1],
                    );

                    p.textFont(font.font);

                    p.textWeight(weight);
                    let width = p.textWidth(message);
                    if (i % 2 === 0) {
                        p.text(message, 0, i * fontSize + fontSize / 2);
                    } else {
                        p.text(
                            message,
                            p.width - width,
                            i * fontSize + fontSize / 2,
                        );
                    }

                    // for (let j = 0; j < message.length; j++) {
                    //     let x = (p.width / message.length) * j;
                    //     let y = i * fontSize;

                    //     if (
                    //         Math.abs(x - p.mouseX) < 500 &&
                    //         Math.abs(y - p.mouseY) < 500
                    //     ) {
                    //         let dist = Math.sqrt(
                    //             Math.pow(x - p.mouseX, 2) +
                    //                 Math.pow(y - p.mouseY, 2),
                    //         );
                    //         p.textWeight(weight + p.map(dist, 0, 500, 300, 0));
                    //     } else {
                    //         p.textWeight(weight);
                    //     }

                    //     p.text(message[j], x, y);
                    // }
                }
            };
        });
    </script>
</GenartLayout>
